# k8s的架构

集群分为：

- 控制平面（主节点）
- （工作）节点

主节点组件：

- etcd分布式持久化存储
- api服务器
- 调度器
- 控制器管理器

工作节点组件：

- kubelet
- kubelet服务代理
- 容器运行时（Docker、rkt或者其他）

附加组件：

- dns服务器
- 仪表盘
- Heapster（容器集群监控）
- 容器网络接口插件

## 组件的分布式特性

### 组件通信

![image-20201022224151089](img\image-20201022224151089.png)

api服务器对外暴露一个ComponentStatus的api资源，通过它可以显示控制平面组件的状态

```shell
kubectl get componentstatuses
```

k8s 组件间只能通过api服务器通信，同时api服务器是和etcd通信的唯一组件。

基本都是由其他组件对api服务器发起通信，不过使用

```shell
kubectl获取日志
kubectl attach
kubectl port-forward
```

时，api服务器会像kubelet 发起连接。

### 组件的实例

etcd和api服务器可以多个实例同时工作，但是调度其和控制器管理器在给定时间内只能由一个实例起作用。其他实例处于待命。

控制平面的组件以及kube-proxy可以直接部署在系统上或者作为pod来运行。kubelet时唯一一致作为常规系统组件来运行的组件，它把其他组件作为pod来运行。为了将控制平面作为pod来运行，kubelet被部署在master。

![image-20201022225857441](img\image-20201022225857441.png)

## etcd

​		本书创建的所有对象都需要持久化方式存储到某个地方，这个他们的manifest在apif服务器重启和失败的时候才不会丢失。

​		etcd是一个响应快、分布式、一致的key-value存储。直接和api服务器通信。

​		它将数据存储到/registry下.

![image-20201022230845077](img\image-20201022230845077.png)

```shell
etcdctl ls /registry
```

v3 无法使用ls命令查看，可以通过`etcdctl get /registry --prefix=true`列出所有给定前缀开始的key。

![image-20201022231301297](img\image-20201022231301297.png) 

### 有效性

k8s中国所有其他组件，只能通过api服务器操作存储模块，同时api服务器实现了乐观锁，因此保证写入存储的数总是有效的。

### 一致性

使用RAFT一致性算法。只有大部分节点参与，才能进入到下一个状态。

![image-20201022232239012](img\image-20201022232239012.png)

![image-20201022232438535](img\image-20201022232438535.png)

## api服务器