# k8s的架构

集群分为：

- 控制平面（主节点）
- （工作）节点

主节点组件：

- etcd分布式持久化存储
- api服务器
- 调度器
- 控制器管理器

工作节点组件：

- kubelet
- kubelet服务代理
- 容器运行时（Docker、rkt或者其他）

附加组件：

- dns服务器
- 仪表盘
- Heapster（容器集群监控）
- 容器网络接口插件

## 组件的分布式特性

### 组件通信

![image-20201022224151089](img\image-20201022224151089.png)

api服务器对外暴露一个ComponentStatus的api资源，通过它可以显示控制平面组件的状态

```shell
kubectl get componentstatuses
```

k8s 组件间只能通过api服务器通信，同时api服务器是和etcd通信的唯一组件。

基本都是由其他组件对api服务器发起通信，不过使用

```shell
kubectl获取日志
kubectl attach
kubectl port-forward
```

时，api服务器会像kubelet 发起连接。

### 组件的实例

etcd和api服务器可以多个实例同时工作，但是调度其和控制器管理器在给定时间内只能由一个实例起作用。其他实例处于待命。

控制平面的组件以及kube-proxy可以直接部署在系统上或者作为pod来运行。kubelet时唯一一致作为常规系统组件来运行的组件，它把其他组件作为pod来运行。为了将控制平面作为pod来运行，kubelet被部署在master。

![image-20201022225857441](img\image-20201022225857441.png)

## etcd

​		本书创建的所有对象都需要持久化方式存储到某个地方，这个他们的manifest在apif服务器重启和失败的时候才不会丢失。

​		etcd是一个响应快、分布式、一致的key-value存储。直接和api服务器通信。

​		它将数据存储到/registry下.

![image-20201022230845077](img\image-20201022230845077.png)

```shell
etcdctl ls /registry
```

v3 无法使用ls命令查看，可以通过`etcdctl get /registry --prefix=true`列出所有给定前缀开始的key。

![image-20201022231301297](img\image-20201022231301297.png) 

### 有效性

k8s中国所有其他组件，只能通过api服务器操作存储模块，同时api服务器实现了乐观锁，因此保证写入存储的数总是有效的。

### 一致性

使用RAFT一致性算法。只有大部分节点参与，才能进入到下一个状态。

![image-20201022232239012](img\image-20201022232239012.png)

![image-20201022232438535](img\image-20201022232438535.png)

## api服务器

其他组件都会去调用api服务器，而api服务器会去主动调用etcd。api服务器一RESTful API提供可查询、修改集群状态的curd。并将状态存储在etcd

![image-20201025091253553](E:\0git_note\docker\img\image-20201025091253553.png)

- 认证插件

多个，直到有一个能确定时谁发的请求。

- 授权插件

多个，确定用户是否可以在请求命名空间执行操作。

- 准入插件

多个，需要经过所有准入插件，用于修改资源、初始化、重写。（请求是读取，则不会做准入控制验证）

![image-20201025091657158](E:\0git_note\docker\img\image-20201025091657158.png)

api服务器只启动控制器以及一些组件来监控已部署资源的变更。其他组件像api服务器发起监控请求，而api服务器在收到修改通知，就会返回信息给监控的组件。

![image-20201025092118084](E:\0git_note\docker\img\image-20201025092118084.png)

比如： --watch监听

```shell
kubectl get pods --watch
```

用于监听pod的变化。

## 调度器

指定资源在哪个集群节点上。

可以在集群中运行多个调度器。对每个pod，可以通过设置schedulerName 指定调度器。未设置默认是default-scheduler

## 控制器

用于确保系统真实状态朝api服务器定义的期望状态收敛。

单个控制器管理器进程 组合了多个执行不同且不冲突任务的控制器。

![image-20201025093643373](E:\0git_note\docker\img\image-20201025093643373.png)

这些控制器都是通过api服务器监听资源，起到一个调和循环，将实际状态调整为期望状态。然后将实际状态写入到资源的status。使用监听机制无法保证不会漏掉时间，所以需要定期执行重列举操作做来确保不会丢掉什么。

### 源码

![image-20201025095020266](E:\0git_note\docker\img\image-20201025095020266.png)

###  Replication控制器

通过监听机制，而非循环交互。不过它只会去创建pod清单，发布到api服务器，让调度器和kubelet调度和运行pod。

![image-20201025100146405](E:\0git_note\docker\img\image-20201025100146405.png)

其他：329

### 唤醒控制器

控制器是通过api服务器来操作api对象。他们不会直接和kubelet通信。

## kubelet

它负责所有运行在工作节点上内容的组件。

kubelet一般会和api服务器通信中获取pod清单，也可以将pod清单放到kubelet清单目录中，让kubelet运行和管理他们。

![image-20201025101217433](E:\0git_note\docker\img\image-20201025101217433.png)

## kubenetes service proxy

确保对服务ip和端口的连接，最终能传输到对应的pod上。用于接收连接，代理给pod。起到一个负载均衡的作用。

![image-20201025102006246](E:\0git_note\docker\img\image-20201025102006246.png)

## 插件

插件用于启动k8s服务的dns查询、单个外部ip暴露给多个http服务，k8sweb 仪表盘等。

![image-20201025102613773](E:\0git_note\docker\img\image-20201025102613773.png)