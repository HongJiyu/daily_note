# acid

atomicity

- autocommit
- commit
- rollback

consistency

- crash recovery
- doublewrite buffer

isolation

- autocommit
- isolation level
- lock

durability

- doublewrite
- innodb_fulsh_log_at_trx_commit
- sync_binlog
- innodb_file_per_table
- ......

原子性：undo log

隔离级别：mvcc + 锁

持久化（将内存写到磁盘文件）：redolog + dwb + binlog

一致性（上面三个保证了最终一致性）

# 总图

https://dev.mysql.com/doc/refman/5.7/en/innodb-architecture.html

![image-20220130172322231](images/image-20220130172322231.png)



![image-20220224221407604](E:\dailynote\mysql\mysql官网\images\image-20220224221407604.png)

# 内存结构

## buffer pool

- lru list ， 通过变种lru算法存放数据页、索引页等。

防止缓存污染：midpoint 点（记住3/8和5/8），及innodb_old_blocks_time 

- free list ， 管理buffer pool的空闲页
- flush list ， 管理需要被刷盘的脏页

## change buffer

**对象：非唯一的索引。**

​      对于这类数据页的操作，先判断操作数据页是否在缓冲池中.如果在,则直接修改,如果不在,则先放入一个插入缓冲区中.然后再以一定的频率执行插入缓冲的合并操作.

**好处：**

​		不用每次都进行插入/更新/删除操作都进行io。

**为什么针对非唯一索引：**

​       唯一索引会进行唯一性检查，数据页即使不在缓冲池中，也会将页读取到内存，进行检查因此还是会进行io操作。

## adaptive hash index

mysql会根据需要自动加入，通过hash定位到buffer pool中的数据页，比如在联表查询时，通过通过驱动表的id到被驱动表找数据时，使用自适应哈希索引能有效提高性能。具体看上图

## log buffer

无

# 磁盘结构

## doublewrite buffer

场景：内存的数据页是16KB的，而磁盘是4KB的（磁盘io最小是512字节）也就是一个内存数据页要刷到磁盘上，需要分4次，但是这种操作不是原子性的，如果刷盘时宕机了，那么会导致磁盘数据页损坏。这时候无法通过redolog来做宕机恢复。

解决：刷盘时，先将数据页写入到内存中的dwb，内存的dwb先写入到磁盘中的dwb，再将内存的dwb写入到磁盘中。如果磁盘的数据也损坏了。也可用通过（磁盘）表空间文件的dwb来恢复。

## redo log

- 为什么要redo log

是innodb独有的，如果没有redo log，那就是直接该内存的数据页，一旦数据库宕机，数据页没有刷盘，就会导致数据丢失。而写入redo log，可以保证内存数据被持久化，同时写redo log是顺序写，效率高。

- redo log 和bin log同步

两阶段提交，先写redolog，且标记为prepare。写binlog，commit，redolog标记为commit。

## undo log

https://dev.mysql.com/doc/refman/5.7/en/innodb-multi-versioning.html  （官方）

https://www.cnblogs.com/jtjs1989/p/11101492.html （翻译）

https://www.cnblogs.com/zrzct/p/14192093.html （解读）

- 实现事务回滚
- 实现读一致性（读快照）

# 事务和锁

- 事务
- 锁 （记录锁、间隙锁、临建锁）
- mvcc 

待看：https://juejin.cn/post/7057471090964037639

# 流程

mysql 通过内存来提高性能。 内存数据 不及时刷盘 （略：sync-binlog=1） ，因此引出redo log，而redo log要和binlog同步，因此引出 二阶段提交。 宕机需要恢复内存数据，可以通过redolog恢复，如果宕机时还存在刷盘操作，会导致磁盘数据页损坏，因此引出doublewrite buffer.