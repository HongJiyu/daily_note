B+树的B不是代表二叉（binary），而是代表平衡（balance），因为B+树从最早的平衡二叉树演化而来，但是B+树不是一个二叉树。

B+树索引并不能找到一个给定键值的具体行，而是找到数据行所在的页，然后数据库将页读到内存，再在内存中进行查找，最后得到要查找的数据。

# 数据结构与算法

- 二分查找：每页page directory中的槽是按照主键的顺序存放的，对于某一条具体记录的查询是通过对page directory进行二分查找得到的。（page directory是一个页，内部有很多记录，按主键顺序排序，通过二分查找到）
- 二叉查找树：满足左小于中，右大于中即可
- 平衡二叉树：满足二叉查找树的基础上，还满足节点的两个子树高度差不超过1。（性能是比较好的，但不是最好的，最优二叉树的建立和维护需要大量操作）。

![image-20210110182751951](image\image-20210110182751951.png)

# B+树

为磁盘或其他直接存取辅助设备设计的一种平衡查找树。

**插入的3种情况：**P188

![image-20210111222207382](E:\0git_note\mysql\mysql技术内幕\image\image-20210111222207382.png)

**删除操作：**

![image-20210111224240154](E:\0git_note\mysql\mysql技术内幕\image\image-20210111224240154.png)

# B+树索引

高扇出性。

树的高度在2-4层，即每次最多2-4次io，一般机械磁盘100次io/s，因此只需要0.02-0.04s。

## 聚集索引

聚集索引的叶子页也称为数据页。由于实际数据页只能按照一颗B+树进行排序，因此每张表只能拥有一个聚集索引。而且聚集索引定义了数据的逻辑顺序，因此查询优化器能够快速发现某一段范围的数据的数据页需要扫描。

聚集索引的存储并不是物理上的连续，而是逻辑上的连续。（物理上的连续成本很高）

- 页按照主键的顺序排序。
- 页种的记录也是通过双向链表进行维护。

物理存储上可以同样不按照主键存储。

**聚集索引的另一个好处：对主键的排序和范围查找速度非常快。**

## 辅助索引

![image-20210112221843108](E:\0git_note\mysql\mysql技术内幕\image\image-20210112221843108.png)

辅助索引叶子节点存储的是索引值以及对应主键id，高度分别为3的辅助索引树和聚集索引树。那么总共需要进行6次io。

# B+索引树的分裂

涉及到并发，这才是b+树索引最为困难的部分。P200

# B+树索引的管理

![image-20210112223052006](E:\0git_note\mysql\mysql技术内幕\image\image-20210112223052006.png)

可以只索引字段的开头：

```mysql
# 对字段b的前100做索引，索引名为idx_b
alter talbe t add key idx_b (b(100)); 
```

查看索引：`show index from  <talbeName>`

![image-20210112225329256](E:\0git_note\mysql\mysql技术内幕\image\image-20210112225329256.png)

cardinality，优化器会根据这个值来判断是否使用这个索引。但是这个值并不是实时更新的，因为代价太大。如果要更新，`analyze table <tableName>`

建议在非高峰时间，对程序的几张核心表做analyze table操作，这使优化器和索引能更好地为你工作。

## fast index creation

5.5版本之前，对于索引的添加或删除的这类ddl操作。

![image-20210112230443606](E:\0git_note\mysql\mysql技术内幕\image\image-20210112230443606.png)

临时表依靠`tmpdir`，如果空间不够，则创建索引失败。

**缺点：**

- 对大表很耗时。
- 大量事务访问，将导致数据库服务不可用。

快速创建索引的方式（fic）

对象：辅助索引。

操作：创建索引时，对表加上s锁。不需要重建表。删除索引，innodb引擎只更新内部视图，并将辅助索引的空间标记为可用（不可用吧），同事删除mysql数据库内部视图上对该表的索引定义。

**fic优点：**上s锁，只能进行读，如果是写操作，则同样不可用。

仅限于辅助索引，对主键创建和删除同样需要一张表。

## oline schema change（略）

一个php脚本。

## online DDL

5.6版本支持在线数据定义操作，允许辅助索引创建的同时，还允许：insert、update、delete这类dml操作。

其他ddl操作也允许通过“在线”的方式进行操作。

在线：事务（索引吧）的创建过程，可以有读写事务对表进行操作，这提高了mysql在ddl操作时的并发性。

- 辅助索引的创建与删除
- 改变自增值
- 添加或删除外键约束
- 列的重命名