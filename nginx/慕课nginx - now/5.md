# 常见问题

1. 多个虚拟主机存在server_name 相同时优先级

哪个配置被优先读取，则被使用。

2. location匹配优先级

= ：完全匹配，匹配到则不会再往下找

^~：普通字符匹配，前缀匹配，匹配到则不会再往下找

~ \ ~*：执行正则匹配，匹配到还会继续往下找优先级高的。

=  大于 ^~  大于 ~\ ~* 大于  / 

3. try_files的使用

按顺序检查文件是否存在

![image-20211005160519862](E:\dailynote\nginx\慕课nginx - now\images\image-20211005160519862.png)

先在nginx访问请求文件是否存在，不存在，再访问后端服务。

4. alias和root 

![image-20211005162437888](E:\dailynote\nginx\慕课nginx - now\images\image-20211005162437888.png)

![image-20211005162424925](E:\dailynote\nginx\慕课nginx - now\images\image-20211005162424925.png)

5. 获取用户真实ip地址

- x-forword-for 会被篡改
- 第一级nginx 进行 set x_real_ip = $remote_addr （使用这个）

6. 413：request entity too large 

配置 client_max_body_size

7.  502 bad gatewar ，后端关闭了服务

8. 504 gateway time-out ，后端服务执行超时



# nginx性能优化

## ab接口压力测试工具

`yum install httpd-tools`

![image-20211005164302860](E:\dailynote\nginx\慕课nginx - now\images\image-20211005164302860.png)

![image-20211005164845407](E:\dailynote\nginx\慕课nginx - now\images\image-20211005164845407.png)

## 文件句柄

- 用户、全局限制

/etc/security/limits.conf 

![image-20211005170119878](E:\dailynote\nginx\慕课nginx - now\images\image-20211005170119878.png)

soft表示发送邮件提醒。hard表示直接限制

- 进程限制

nginx.conf

worker_rlimit_nofile  xxxx;

## cpu亲和

物理cpu

`cat /rpoc/cpuinfo|grep "physical id"|sort|uniq|wc -l`

单个cpu的核心

`cat /proc/cpuinfo|grep "cpu cores"|uniq`

查看各个cpu进程使用率

`top  再按 1 `



每个worker绑定一个cpu

![image-20211005171027298](E:\dailynote\nginx\慕课nginx - now\images\image-20211005171027298.png)

查看nginx绑定cpu

![image-20211005171349549](E:\dailynote\nginx\慕课nginx - now\images\image-20211005171349549.png)

nginx 1.9版本 自动分配绑定

`worker_cpu_affinity auto`

## 其他配置

1. 

![image-20211005172141951](E:\dailynote\nginx\慕课nginx - now\images\image-20211005172141951.png)

使用epoll作为事件模型

每个工作进程支持连接数

2. 

![image-20211005172251002](E:\dailynote\nginx\慕课nginx - now\images\image-20211005172251002.png)

返回给客户端时，强制转成utf-8

3. 
