# 静态资源web服务

## 静态资源获取配置

todo

文件读取：

![image-20211004195433880](images/image-20211004195433880.png)

提高网络包的传输效率（sendfile开启下，大文件下）：

![image-20211004195535109](images/image-20211004195535109.png)

keepalive连接下，提高网络包的传输实时性：

![image-20211004195647674](images/image-20211004195647674.png)

压缩：

![image-20211004195800621](images/image-20211004195800621.png)

![image-20211004195833651](images/image-20211004195833651.png)

![image-20211004195935170](images/image-20211004195935170.png)

![image-20211004195945848](images/image-20211004195945848.png)

## 扩展nginx的压缩模块

![image-20211004200222921](images/image-20211004200222921.png)

gzip_static ：需要自己预先将文件压缩成gzip格式，如：访问1.png，需要预先压缩成 1.png.gz ，然后访问时，nginx会去读gz文件。

## 案例

![image-20211004200539381](images/image-20211004200539381.png)

## 浏览器缓存

![image-20211004202040193](images/image-20211004202040193.png)

last-modified：上次修改时间，单位为s。

Etag：一连串字符串

![image-20211004202326247](images/image-20211004202326247.png)

![image-20211004202428518](images/image-20211004202428518.png)

## 案例

![image-20211004202500306](images/image-20211004202500306.png)

  

请求时，请求头：max-age=0 浏览器自己加的，每一次都要去校验

## 跨域访问

todo

在当前域名的网页下，访问另一个域名的接口。

跨站：应该是协议、域名、端口有不一致，就算跨站。

![image-20211004204653361](images/image-20211004204653361.png)

## 案例

![image-20211004204906090](images/image-20211004204906090.png)

![image-20211004204840892](images/image-20211004204840892.png)

## 防盗链

防止资源被盗用

- 基于http_refer防盗链配置 （简单的设置）

![image-20211005100617364](E:\dailynote\nginx\慕课nginx - now\images/image-20211005100617364.png)

使用curl进行验证 `curl -e "请求时的refer内容" -I "http://xxxx"` 

-I 表示只看头信息即可

-e 伪造请求头的refer值

# 代理服务

正向代理和反向代理

正向代理服务于客户端，隐藏客户端信息，去访问服务端信息。

反向代理服务于服务端，客户端不知道服务端信息，由代理去完成请求。

![image-20211005101430318](E:\dailynote\nginx\慕课nginx - now\images/image-20211005101430318.png)

## 反向代理（todo）

![image-20211005101946377](E:\dailynote\nginx\慕课nginx - now\images/image-20211005101946377.png)

## 正向代理

一台nginx a配置只允许某个ip访问

![image-20211005103647155](E:\dailynote\nginx\慕课nginx - now\images/image-20211005103647155.png)

一台nginx b配置代理到nginx b

编写域名需要dns解析，配置的谷歌的dns

![image-20211005103757004](E:\dailynote\nginx\慕课nginx - now\images/image-20211005103757004.png)

然后本地配置host，去访问nginxb， 由nginx获取到请求的host（域名）和请求的uri（路径），然后再代理到真正的nginx a中

## 其他（todo）

![image-20211005104226760](E:\dailynote\nginx\慕课nginx - now\images/image-20211005104226760.png)

![image-20211005104252979](E:\dailynote\nginx\慕课nginx - now\images/image-20211005104252979.png)

![image-20211005104516282](E:\dailynote\nginx\慕课nginx - now\images/image-20211005104516282.png)

![image-20211005104557627](E:\dailynote\nginx\慕课nginx - now\images/image-20211005104557627.png)

![image-20211005104948623](E:\dailynote\nginx\慕课nginx - now\images/image-20211005104948623.png)

# 负载均衡调度器SLB

![image-20211005110123985](E:\dailynote\nginx\慕课nginx - now\images/image-20211005110123985.png)

## 服务状态

![image-20211005110411618](E:\dailynote\nginx\慕课nginx - now\images/image-20211005110411618.png)

验证时，可以使用iptable来使某些端口不提供服务。

`ipttables -I INPUT -p tcp --dport 8003 -j DROP`

## 调度算法

![image-20211005112551575](E:\dailynote\nginx\慕课nginx - now\images/image-20211005112551575.png)

### ip_hash

remote_addr 

缺陷：如果有多层代理，则该ip不是客户的ip，而是代理机器的ip

![image-20211005113113969](E:\dailynote\nginx\慕课nginx - now\images/image-20211005113113969.png)

### url_hash

这个request_uri包含了请求参数，如果想对参数进行hash，通过正则提取出来，再进行hash

![image-20211005112945442](E:\dailynote\nginx\慕课nginx - now\images/image-20211005112945442.png)



# 动态缓存

服务端缓存：redis，memcache，内存

代理缓存：nginx

客户端缓存：浏览器

![image-20211005135739926](E:\dailynote\nginx\慕课nginx - now\images/image-20211005135739926.png)

![image-20211005135929416](E:\dailynote\nginx\慕课nginx - now\images/image-20211005135929416.png)

缓存过期周期

![image-20211005135959894](E:\dailynote\nginx\慕课nginx - now\images/image-20211005135959894.png)

缓存维度

![image-20211005140023923](E:\dailynote\nginx\慕课nginx - now\images/image-20211005140023923.png)

## 案例

![image-20211005141001171](E:\dailynote\nginx\慕课nginx - now\images/image-20211005141001171.png)

## 清理缓存

- rm -rf 缓存目录
- 第三方模块  ngx_cache_purge

## 部分页面不缓存

![image-20211005141255400](E:\dailynote\nginx\慕课nginx - now\images/image-20211005141255400.png)

![image-20211005141428697](E:\dailynote\nginx\慕课nginx - now\images/image-20211005141428697.png)

# 大文件分片请求

todo

![image-20211005141606841](E:\dailynote\nginx\慕课nginx - now\images/image-20211005141606841.png)

