egg-core包

其根目录下的index.js，指明了对外暴露的资源：

EggCore  整个包最核心的类，内嵌了EggLoader。

EggLoader 其原型上内嵌了所有资源的加载器。

BaseContentClass 基础类。构造方法用于将资源挂载到它根路径上。

utils 提供整个文件需要用到的工具类。



主要还是loader文件夹，里面包含了对每种资源的加载。

粗略地阅读了plugin的内容：

egg-core/lib/loader/mixin/plugin.js

从loadPlugin()入手，整体流程为：

1.获取应用和所有框架的插件配置文件，并为每个插件配置初始化属性。因为插件可以简略配置如：`redis：true` 变为：

```js
plugins[name] = {
        name,
        enable: plugin,
        dependencies: [],
        optionalDependencies: [],
        env: [],
        from: configPath,
      }
```

同时从`EGG_PLUGINS`环境变量获取用户自定义插件。

2.合并所有插件配置，用户自定义配置覆盖应用插件，应用插件覆盖框架插件。

3.为每个插件配置赋予对应的插件依赖的路径（path属性）。先从应用路径的node_modules=》框架的node_modules再到命令执行路径下的node_modules。

4.将插件依赖包的package.json的`'dependencies', 'optionalDependencies', 'env'`覆盖插件配置属性。

5.根据当前的`EGG_SERVER_ENV`和插件的env，来禁用某些插件。

6.getOrderPlugins调用utils中sequencify方法：检查插件的依赖关系、依赖包是否完整，如果存在循环依赖、依赖不完整则报错。对被依赖的插件，但是被禁用的，重新设置为enable。并返回最终的所有插件配置。



config：简单，用了configMeta记录了所有配置的属性，并值更改为filePath。

使用extend2 来进行合并。、

1. 预先加载应用的两个配置`'config.default'和config.${this.serverEnv}`

2. 遍历所有插件、框架以及应用的配置，并将预先加载的应用的值传递给插件和框架的加载配置中。
3. 使用extend来进行合并。
4. 加载环境变量`EGG_APP_CONFIG`的定义的配置。
5. 如果不存在，则初始化coreMiddleware和appMiddleware
6. 同时以上所有参数的合并过程中，有一个`configMeta`用来记录所有配置合并后的结果，不过将其值更改为filePath。





