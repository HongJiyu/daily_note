# 操作系统

操作系统用于屏蔽物理硬件，同时对外提供api，使得能够操作系统资源。

# 进程

进程是操作系统资源分配和调度的基本单位。

作为程序独立允许的载体，保障程序正常执行。

## 进程状态

创建、就绪、运行、阻塞、终止。

就绪：除CPU资源外的所有必要资源都准备好了，那么进程处于就绪状 态。

运行：拿到CPU资源。

阻塞：等待IO。

创建：拥有PCB但其他资源尚未就绪。

终止：进程结束由系统清理或者归还PCB的状态称为终止状态。

## 同步异步

同步和异步关注的是**调用之后做什么事情**

- 同步：主动等待结果
- 异步：可以去做其他事情

阻塞和非阻塞关注的是**程序在等待调用结果（消息，返回值）时的状态.**

- 阻塞：等待调用结果，不过处于干等着的状态。
- 非阻塞：等待调用结果，但是你可以隔1s询问一次。

https://www.zhihu.com/question/19732473

## 进程和线程

进程是系统资源分配的基本单位，而线程是cpu调度的基本单位。

进程强调的是资源的分配，而线程强调的是运行。

线程包含在进程中，是进程实际运行工作的单位。一个进程可以并发多个线程，每个线程处理不同的任务。

线程共享进程的资源，因为资源分配是以进程为单位分配，因此线程只能拿进程的资源。

上下文切换的成本（从一个线程切换到另一个线程执行）：进程内线程的上下文切换开销小，不同进程间的线程上下文切换开销大。

## 协程

nodejs使用generate函数实现协程。

**协程是一种用户态、轻量级线程**

当协程遇到阻塞时，就切换线程控制权，让线程去执行另外一个协程。

在实际业务中有大量I/O，网络访问操作会引起阻塞，此时通过协程API将阻塞任务睡眠（注意，不是调度到其他线程上，因为这个阻塞动作本身就是在等待别的资源响应，没有必要浪费资源），释放出空闲资源供其他协程使用。

- 遇到io操作就通过协程api阻塞然后切换其他协程，适用于多io的场景。
- 协程是用户态的，因此切换不需要经过内核系统调用，更加轻量。
- 无法发挥CPU的多核资源，主要运用在多io的场景。可以开启多个CPU来实现多核资源。

## 线程间的通信（同步）

依靠互斥锁、读写锁、自旋锁等。

## 进程间的通信（同步）

管道（匿名、命名）

`ps -aux|grep xxx`就使用到了管道。

消息队列

共享内存

信号（kill -l 查看信号）

套接字

# 内核态，用户态

因为操作系统直接提供出来的api，很多重要且危险，不能够随意调用，不然导致系统错误。因此分为内核态和用户态。

内核态执行重要的事情，而用户态。

## 切换

用户态 =》内核态

系统调用、异常中断、外围设备中断

## 内核态

- 存放的是内核代码和数据
- 执行操作系统内核的代码
- cpu可以访问内存所有数据和外围设备

## 用户态

- 存放的是用户程序的代码和数据
- 进程在执行用户自己的代码
- cpu只可以访问有限的内存，不允许访问外设。

# 内存管理

https://blog.csdn.net/lvyibin890/article/details/82193900

https://blog.csdn.net/lvyibin890/article/details/82217193

进程所能寻址的空间大小与操作系统位数有关，32 =》4G    （逻辑地址）

## 虚拟内存

虚拟内存用于解决内存不足的情况。

程序运行时，无需全部装入内存，装载部分即可。

如果访问页不存在内存，则发出缺页中断，发起页面置换。

虚拟内存和物理内存存在映射关系。

## 页式存储管理

将虚拟内存分为页，将物理内存页分为页，中间用页表进行映射。

在32位操作系统中，假如每页4KB，则页表有1M个页表项，假如每页表项目占用1B，则进程就需要1MB的内存空间来存放逻辑地址与物理地址的映射关系。

多级页表来减少页表的开销。

缺点：有一段连续的逻辑分布在多个物理页面中，将导致执行效率降低。

## 段式存储管理

将虚拟内存按逻辑段进行划分，通过段表（段号、基址、段长）来找到对应的物理地址。

解决页式存储出现的问题（连续逻辑段的执行效率低。）

## 段页式

先将逻辑空间按逻辑段进行划分。再将每一段按页式管理进行划分。

## 页表

页表的每一个表项分两部分，第一部分记录此页是否在物理内存上，第二部分记录物理内存页的地址

## 缺页中断

通过页表来确定要查询的物理页是否存在内存中，当所要访问的页不在内存中，则产生缺页中断。然后通过页表的外存地址找到所缺的那页，将其调入内存。

- 缺页中断时，读写磁盘需要系统调用（进入内核态）
- 一条指令可能产生多次缺页中断。
- 进程处于阻塞状态。

## 页面置换算法

# 文件系统

文件=inode+block ，inode存放元信息，block存放元数据

ext文件系统（linux）

- inode table

存放所有inode的信息，每一个文件（目录）都有一个inode，是每一个文件的索引节点。inode存放文件的元信息（文件类型、权限、长度、链接数）。文件名是存放在目录的inode上。

- inode bitmap

记录已分配的inode和未分配的inode

- data block

具体存放文件内容的地方。

- block bitmap

## 软链和硬链

使用ln来链接。

源文件 =》inode =》block

硬链接 =》源的inode

软连接 =》inode =》block =》源文件的地址

每个文件对应一个inode和block。

硬链接，直接指向源文件的inode，通过inode信息可以查看链接次数。

软链接，有自己的inode和block，而block中指向源文件的地址。删除软链接对源文件没有影响。删除源文件，对软链也没影响，只会出现访问不存在。